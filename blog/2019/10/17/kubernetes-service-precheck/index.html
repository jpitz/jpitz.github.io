<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link type="application/atom+xml" rel="alternate" href="https://www.mjpitz.com/feed.xml" title="Mya Pitzeruse" />
        <meta name="author" content="Mya Pitzeruse">

        <title>
            
                Checking Service Dependencies in Kubernetes
            
        </title>

        

        <link rel="stylesheet" href="/statics/libs/bootstrap-3.3.7/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/statics/libs/font-awesome-5.4.1/css/all.min.css">
        <link rel="stylesheet" href="/statics/css/syntax-highlighting.css"/>
        <link rel="stylesheet" href="/statics/css/app.css"/>

        <link rel="apple-touch-icon" sizes="180x180" href="/statics/img/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/statics/img/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/statics/img/favicon-16x16.png">
        <link rel="manifest" href="/statics/img/site.webmanifest">
        <link rel="mask-icon" href="/statics/img/safari-pinned-tab.svg" color="#a28ad2">
        <link rel="shortcut icon" href="/statics/img/favicon.ico">
        <link rel="icon" href="/statics/img/favicon.ico" type="image/x-icon">
        <meta name="msapplication-TileColor" content="#eeeeee">
        <meta name="msapplication-config" content="/statics/img/browserconfig.xml">
        <meta name="theme-color" content="#eeeeee">
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="navbar-brand">@mjpitz</div>
                </div>

                <div class="collapse navbar-collapse" id="menu">
                    <ul class="nav navbar-nav mr-auto">
                        <li>
                            <a href="/">
                                <i class="fas fa-home" title="Blog" data-toggle="tooltip" data-placement="bottom">
                                    <span>Blog</span>
                                </i>
                                Blog
                            </a>
                        </li>
                    </ul>
                    
                    <ul class="nav navbar-nav nav-social">
                        <li>
                            <a href="https://medium.com/@mjpitz">
                                <i class="fab fa-medium" title="Medium" data-toggle="tooltip" data-placement="bottom">
                                    <span>Medium</span>
                                </i>
                            </a>
                        </li>
                        
                        <li>
                            <a href="http://www.github.com/mjpitz">
                                <i class="fab fa-github" title="GitHub" data-toggle="tooltip" data-placement="bottom">
                                    <span>GitHub</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="https://hub.docker.com/u/mjpitz">
                                <i class="fab fa-docker" title="Docker" data-toggle="tooltip" data-placement="bottom">
                                    <span>Docker</span>
                                </i>
                            </a>
                        </li>
                        
                        <li>
                            <a href="http://www.twitter.com/_mjpitz_">
                                <i class="fab fa-twitter" title="Twitter" data-toggle="tooltip" data-placement="bottom">
                                    <span>Twitter</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="http://www.linkedin.com/in/mjpitz">
                                <i class="fab fa-linkedin" title="LinkedIn" data-toggle="tooltip" data-placement="bottom">
                                    <span>LinkedIn</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="/feed.xml">
                                <i class="fas fa-rss" title="Feed" data-toggle="tooltip" data-placement="bottom">
                                    <span>Feed</span>
                                </i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mjpitz-content" style="margin-top:82px">
            <div class="panel panel-default">
    <div class="panel-body">
        <div class="post">
            <h1 class="post-title">Checking Service Dependencies in Kubernetes</h1>
            <p class="post-date">Posted on October 17, 2019</p>

            <div class="post-content">
                <p>Back in July, I found myself needing to better coordinate deployments of my applications to <a href="https://kubernetes.io/">Kubernetes</a>.
After searching around, I found many ways that people where trying to solve this problem.
Some used shell scripts to apply multiple YAML files with a fixed time sleep between them.
Others used shell scripts and tailed the rollout using <code class="highlighter-rouge">kubectl rollout status -w</code>.
Now, I manage a lot of my deployments using <a href="https://www.weave.works/technologies/gitops/">GitOps</a> and <a href="https://github.com/fluxcd/flux">Flux</a>.
So leveraging these shell scripts to manage my rollouts into clusters wasn’t really an option.</p>

<p>It wasn’t until I came across <a href="https://us.alibabacloud.com">Alibaba Cloud’s</a> blog post on <a href="https://www.alibabacloud.com/blog/kubernetes-demystified-solving-service-dependencies_594110">solving service dependencies</a> that I felt like I had something to work with.
The article described two techniques. 
The first was inspecting dependencies within the application itself. 
At Indeed, we leverage our <a href="http://github.com/indeedeng/status">status</a> library to do this. 
The second was to enable services to be checked, independent of the application.</p>

<p>In this post, I’ll demonstrate how to use my <a href="https://hub.docker.com/r/mjpitz/service-precheck">service-precheck</a> initialization container (built off of the Alibaba blog post) to ensure upstream systems are up before attempting to start a downstream system.</p>

<!--more-->

<h2 id="concepts">Concepts</h2>

<p>Before reading this blog post, it would be helpful to familiarize yourself with some Kubernetes concepts (if you don’t already know them).</p>

<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Liveness and readiness probes</a> are used to ensure your applications is live and ready. 
Readiness probes are used to determine when an application is ready and able to start receiving traffic. 
While liveness probes are used to check if the application is alive and running. 
A key difference here is that readiness probes control a pods entry in DNS. 
When a pod’s readiness probe is failing, no DNS entry will be available for the pod.</p>

<p>A <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless service</a> is one who does not expose a <code class="highlighter-rouge">clusterIP</code>, and instead exposes the endpoints of a service as entries in DNS (when using a selector).</p>

<p><a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">initContainers</a> are a set of containers within a pod that run before all other containers. 
These containers tend to be relatively short-lived and are typically used to complete some work before the primary process. 
Examples include preparing temporary file systems, initializing some data on disk, as well as probing required services.</p>

<h2 id="use-case-mysql-primary-and-replica">Use Case: MySQL Primary and Replica</h2>

<p>Consider the case laid out in the Alababa blog post using MySQL. 
Many applications expect to have both read-write and read-only connections. 
These connection strings often have two different targets. 
To ensure these connection strings resolve, simply pass the list of addresses as arguments to the precheck container.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service-precheck</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">mjpitz/service-precheck:latest</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">mysql-0.mysql.namespace"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">mysql-read.namespace"</span>
</code></pre></div></div>

<p>This will ensure that the <code class="highlighter-rouge">nslookup</code> for <code class="highlighter-rouge">mysql-0.mysql.namespace</code> and <code class="highlighter-rouge">mysql-read.namespace</code> return entries before exiting successfully.</p>

<h2 id="use-case-zookeeper-quorum">Use Case: Zookeeper Quorum</h2>

<p>Another popular use case is ensuring quorum amongst a coordinating service, like Zookeeper and etcd. 
A recent example where I’ve needed to add this precheck in was in some exploration with <a href="https://github.com/apache-spark-on-k8s/kubernetes-HDFS">HDFS on Kubernetes</a>. 
All the components of HDFS leverage Zookeeper for service discovery and leader election. 
Until Zookeeper is fully initializied, the namenodes, journalnodes, and datanodes will crash loop looking for the Zookeeper entries. 
With the addition of a service-precheck definition, the namenodes, journalnodes, and datanodes were all able to wait for Zookeeper before starting up.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service-precheck</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">mjpitz/service-precheck:latest</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">zookeeper-0.zookeeper-headless.namespace"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">zookeeper-1.zookeeper-headless.namespace"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">zookeeper-2.zookeeper-headless.namespace"</span>
</code></pre></div></div>

<p>While letting a pod crash loop until it fixes itself is an option, it tends to come at a cost. 
The container engine on that host needs to continually restart the pod. 
More pod events means more load on your control plane. 
By using service-precheck, I’ve been able to better manage my cluster deployments using GitOps.</p>

<p>Check it out on <a href="https://github.com/mjpitz/service-precheck">GitHub</a> and <a href="https://hub.docker.com/r/mjpitz/service-precheck">Docker Hub</a>.</p>

            </div>

            <div class="text-center">
    <br/>
    <br/>
    <p><i>Share this article on</i></p>

    <div style="font-size: 36px;">
        <a rel="nofollow" target="_blank" href="https://facebook.com/sharer.php?u=https://www.mjpitz.com/blog/2019/10/17/kubernetes-service-precheck/">
            <i class="fab fa-facebook" title="Facebook" data-toggle="tooltip" data-placement="bottom"></i></a>
        &nbsp;
        <a rel="nofollow" target="_blank" href="https://twitter.com/intent/tweet?text=Checking Service Dependencies in Kubernetes&url=https://www.mjpitz.com/blog/2019/10/17/kubernetes-service-precheck/&via=&related=">
            <i class="fab fa-twitter" title="Twitter" data-toggle="tooltip" data-placement="bottom"></i></a>
        &nbsp;
        <a rel="nofollow" target="_blank" href="http://www.linkedin.com/sharing/share-offsite/?url=https://www.mjpitz.com/blog/2019/10/17/kubernetes-service-precheck/">
            <i class="fab fa-linkedin" title="LinkedIn" data-toggle="tooltip" data-placement="bottom"></i></a>
    </div>
</div>


            <div class="post-footer row">
                <div class="col-sm-6 text-left">
                    
                        <a class="btn btn-default" href="/blog/2019/05/07/docker-buildx/">&laquo; Previous Post</a>
                    
                </div>

                <div class="col-sm-6 text-right">
                    
                    <a class="btn btn-default" href="/blog/2020/01/24/building-depscloud/">Next Post &raquo;</a>
                    
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
        <div style="padding:25px 0; margin-top: 50px;">
    <div>
        
<!-- Google Analytics (http://google.com/analytics) -->
<script>
    !function(j,e,k,y,l,L){j.GoogleAnalyticsObject=y,j[y]||(j[y]=function(){
        (j[y].q=j[y].q||[]).push(arguments)}),j[y].l=+new Date,l=e.createElement(k),
            L=e.getElementsByTagName(k)[0],l.src='//www.google-analytics.com/analytics.js',
            L.parentNode.insertBefore(l,L)}(window,document,'script','ga');
    ga('create', 'UA-39314903-5', 'auto');
    ga('send', 'pageview');
</script>



        <script src="/statics/libs/jquery-2.1.4/jquery.min.js"></script>
        <script src="/statics/libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>

        <script>
            $(function () {
                //$('[data-toggle="tooltip"]').tooltip();
                $('.collapse').collapse({ toggle: false })
            });
        </script>
    </div>
</div>
    </body>
</html>
