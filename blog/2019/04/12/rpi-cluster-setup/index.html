<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link type="application/atom+xml" rel="alternate" href="https://www.mjpitz.com/feed.xml" title="Mya Pitzeruse" />
        <meta name="author" content="Mya Pitzeruse">

        <title>
            
                Raspberry Pi Cluster Setup
            
        </title>

        

        <link rel="stylesheet" href="/statics/libs/bootstrap-3.3.7/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/statics/libs/font-awesome-5.4.1/css/all.min.css">
        <link rel="stylesheet" href="/statics/css/syntax-highlighting.css"/>
        <link rel="stylesheet" href="/statics/css/app.css"/>

        <link rel="apple-touch-icon" sizes="180x180" href="/statics/img/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/statics/img/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/statics/img/favicon-16x16.png">
        <link rel="manifest" href="/statics/img/site.webmanifest">
        <link rel="mask-icon" href="/statics/img/safari-pinned-tab.svg" color="#a28ad2">
        <link rel="shortcut icon" href="/statics/img/favicon.ico">
        <link rel="icon" href="/statics/img/favicon.ico" type="image/x-icon">
        <meta name="msapplication-TileColor" content="#eeeeee">
        <meta name="msapplication-config" content="/statics/img/browserconfig.xml">
        <meta name="theme-color" content="#eeeeee">
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="navbar-brand">@mjpitz</div>
                </div>

                <div class="collapse navbar-collapse" id="menu">
                    <ul class="nav navbar-nav mr-auto">
                        <li>
                            <a href="/">
                                <i class="fas fa-home" title="Blog" data-toggle="tooltip" data-placement="bottom">
                                    <span>Blog</span>
                                </i>
                                Blog
                            </a>
                        </li>
                    </ul>
                    
                    <ul class="nav navbar-nav nav-social">
                        <li>
                            <a href="https://medium.com/@mjpitz">
                                <i class="fab fa-medium" title="Medium" data-toggle="tooltip" data-placement="bottom">
                                    <span>Medium</span>
                                </i>
                            </a>
                        </li>
                        
                        <li>
                            <a href="http://www.github.com/mjpitz">
                                <i class="fab fa-github" title="GitHub" data-toggle="tooltip" data-placement="bottom">
                                    <span>GitHub</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="https://hub.docker.com/u/mjpitz">
                                <i class="fab fa-docker" title="Docker" data-toggle="tooltip" data-placement="bottom">
                                    <span>Docker</span>
                                </i>
                            </a>
                        </li>
                        
                        <li>
                            <a href="http://www.twitter.com/_mjpitz_">
                                <i class="fab fa-twitter" title="Twitter" data-toggle="tooltip" data-placement="bottom">
                                    <span>Twitter</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="http://www.linkedin.com/in/mjpitz">
                                <i class="fab fa-linkedin" title="LinkedIn" data-toggle="tooltip" data-placement="bottom">
                                    <span>LinkedIn</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="/feed.xml">
                                <i class="fas fa-rss" title="Feed" data-toggle="tooltip" data-placement="bottom">
                                    <span>Feed</span>
                                </i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mjpitz-content" style="margin-top:82px">
            <div class="panel panel-default">
    <div class="panel-body">
        <div class="post">
            <h1 class="post-title">Raspberry Pi Cluster Setup</h1>
            <p class="post-date">Posted on April 12, 2019</p>

            <div class="post-content">
                <p>Previously, I talked about the different orchestration technologies that I’ve run on my Raspberry Pi cluster.
That post was rather high level and only contained details relating to k3s.
In this post, we’ll take a more in depth look at my cluster setup and my management process around it.</p>

<!--more-->

<p>The diagram below roughly shows how I have my home network setup.
I have 2 racks of 5 nodes.
Each rack is independently powered.
Each Raspberry Pi runs <a href="/blog/2019/03/17/64bit-raspberry-pi/">Ubuntu 18.04</a>, has cgroups enabled, and is assigned a static IP.</p>

<p><img src="/statics/img/private-cloud.png" alt="Private Cloud" /></p>

<p>For easy access to each node, I copy my ssh key to each Pi.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-copy-id ubuntu@${ip_address}
</code></pre></div></div>
<p></p>

<p>Then, I use <a href="https://docs.docker.com/machine/overview/">docker-machine</a> to setup and configure docker on each node.
To setup a Raspberry Pi this way, you’ll want to use the <code class="highlighter-rouge">generic</code> machine driver.
The driver requires an IP address, ssh user, ssh key, and a name.
Note that docker-machine will set the hostname of the remote IP to be the name of the machine.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-machine create \
  --driver generic \
  --generic-ip-address ${ip_address} \
  --generic-ssh-user ubuntu \
  --generic-ssh-key ~/.ssh/id_rsa \
  ${name}
</code></pre></div></div>
<p></p>

<p>By leveraging docker-machine, I’m now able to treat my laptop as a remote control to my cluster.
I can see the status of all my machines without any additional monitoring or setup.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-machine ls
NAME        ACTIVE   DRIVER    STATE     URL                        SWARM   DOCKER     ERRORS
myriad-1    *        generic   Running   tcp://192.168.1.100:2376           v18.09.4   
myriad-2    -        generic   Running   tcp://192.168.1.101:2376           v18.09.4   
myriad-3    -        generic   Running   tcp://192.168.1.102:2376           v18.09.3   
myriad-4    -        generic   Running   tcp://192.168.1.103:2376           v18.09.3   
myriad-5    -        generic   Running   tcp://192.168.1.104:2376           v18.09.3   
myriad-6    -        generic   Running   tcp://192.168.1.105:2376           v18.09.3   
myriad-7    -        generic   Running   tcp://192.168.1.106:2376           v18.09.3   
myriad-8    -        generic   Running   tcp://192.168.1.107:2376           v18.09.3   
myriad-9    -        generic   Running   tcp://192.168.1.108:2376           v18.09.3   
myriad-10   -        generic   Running   tcp://192.168.1.109:2376           v18.09.3   
</code></pre></div></div>
<p></p>

<p>Using <code class="highlighter-rouge">docker-machine env</code>, I can configure my laptop’s shell to point to specific nodes in the cluster.
This makes it easy to run, interact with, or extract contents from remote docker containers.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ eval $(docker-machine env myriad-1)

$ docker ps -a
CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS               NAMES
c5ba1248a881        rancher/k3s:v0.3.0-arm64   "/bin/k3s agent"         3 days ago          Up 3 days                               k3s-exec
85aa7d46da72        rancher/k3s:v0.3.0-arm64   "/bin/k3s server --d…"   3 days ago          Up 3 days                               k3s-control

$ docker cp k3s-control:/etc/rancher/k3s/k3s.yaml ~/.kube/k3s
</code></pre></div></div>
<p></p>

<p>As a result, I’m now able to write some rather simple <a href="https://github.com/mjpitz/terraform-rpi/tree/master/scripts">scripts</a> for automating cluster management.
Beyond that, there really isn’t much.
I’ve found working with this setup at home to be really nice as I can easily debug remote issues quickly.</p>

            </div>

            <div class="text-center">
    <br/>
    <br/>
    <p><i>Share this article on</i></p>

    <div style="font-size: 36px;">
        <a rel="nofollow" target="_blank" href="https://facebook.com/sharer.php?u=https://www.mjpitz.com/blog/2019/04/12/rpi-cluster-setup/">
            <i class="fab fa-facebook" title="Facebook" data-toggle="tooltip" data-placement="bottom"></i></a>
        &nbsp;
        <a rel="nofollow" target="_blank" href="https://twitter.com/intent/tweet?text=Raspberry Pi Cluster Setup&url=https://www.mjpitz.com/blog/2019/04/12/rpi-cluster-setup/&via=&related=">
            <i class="fab fa-twitter" title="Twitter" data-toggle="tooltip" data-placement="bottom"></i></a>
        &nbsp;
        <a rel="nofollow" target="_blank" href="http://www.linkedin.com/sharing/share-offsite/?url=https://www.mjpitz.com/blog/2019/04/12/rpi-cluster-setup/">
            <i class="fab fa-linkedin" title="LinkedIn" data-toggle="tooltip" data-placement="bottom"></i></a>
    </div>
</div>


            <div class="post-footer row">
                <div class="col-sm-6 text-left">
                    
                        <a class="btn btn-default" href="/blog/2019/04/10/k8s-k3s-rpi-oh-my/">&laquo; Previous Post</a>
                    
                </div>

                <div class="col-sm-6 text-right">
                    
                    <a class="btn btn-default" href="/blog/2019/04/21/monitoring-rpi-cluster/">Next Post &raquo;</a>
                    
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
        <div style="padding:25px 0; margin-top: 50px;">
    <div>
        
<!-- Google Analytics (http://google.com/analytics) -->
<script>
    !function(j,e,k,y,l,L){j.GoogleAnalyticsObject=y,j[y]||(j[y]=function(){
        (j[y].q=j[y].q||[]).push(arguments)}),j[y].l=+new Date,l=e.createElement(k),
            L=e.getElementsByTagName(k)[0],l.src='//www.google-analytics.com/analytics.js',
            L.parentNode.insertBefore(l,L)}(window,document,'script','ga');
    ga('create', 'UA-39314903-5', 'auto');
    ga('send', 'pageview');
</script>



        <script src="/statics/libs/jquery-2.1.4/jquery.min.js"></script>
        <script src="/statics/libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>

        <script>
            $(function () {
                //$('[data-toggle="tooltip"]').tooltip();
                $('.collapse').collapse({ toggle: false })
            });
        </script>
    </div>
</div>
    </body>
</html>
