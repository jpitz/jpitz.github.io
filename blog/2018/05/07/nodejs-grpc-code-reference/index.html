<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link type="application/atom+xml" rel="alternate" href="https://www.mjpitz.com/feed.xml" title="Mya Pitzeruse" />
        <meta name="author" content="Mya Pitzeruse">

        <title>
            
                NodeJS gRPC Code Reference
            
        </title>

        

        <link rel="stylesheet" href="/statics/libs/bootstrap-3.3.7/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/statics/libs/font-awesome-5.4.1/css/all.min.css">
        <link rel="stylesheet" href="/statics/css/syntax-highlighting.css"/>
        <link rel="stylesheet" href="/statics/css/app.css"/>

        <link rel="apple-touch-icon" sizes="180x180" href="/statics/img/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/statics/img/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/statics/img/favicon-16x16.png">
        <link rel="manifest" href="/statics/img/site.webmanifest">
        <link rel="mask-icon" href="/statics/img/safari-pinned-tab.svg" color="#a28ad2">
        <link rel="shortcut icon" href="/statics/img/favicon.ico">
        <link rel="icon" href="/statics/img/favicon.ico" type="image/x-icon">
        <meta name="msapplication-TileColor" content="#eeeeee">
        <meta name="msapplication-config" content="/statics/img/browserconfig.xml">
        <meta name="theme-color" content="#eeeeee">
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#menu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="navbar-brand">@mjpitz</div>
                </div>

                <div class="collapse navbar-collapse" id="menu">
                    <ul class="nav navbar-nav mr-auto">
                        <li>
                            <a href="/">
                                <i class="fas fa-home" title="Blog" data-toggle="tooltip" data-placement="bottom">
                                    <span>Blog</span>
                                </i>
                                Blog
                            </a>
                        </li>
                    </ul>
                    
                    <ul class="nav navbar-nav nav-social">
                        <li>
                            <a href="https://medium.com/@mjpitz">
                                <i class="fab fa-medium" title="Medium" data-toggle="tooltip" data-placement="bottom">
                                    <span>Medium</span>
                                </i>
                            </a>
                        </li>
                        
                        <li>
                            <a href="http://www.github.com/mjpitz">
                                <i class="fab fa-github" title="GitHub" data-toggle="tooltip" data-placement="bottom">
                                    <span>GitHub</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="https://hub.docker.com/u/mjpitz">
                                <i class="fab fa-docker" title="Docker" data-toggle="tooltip" data-placement="bottom">
                                    <span>Docker</span>
                                </i>
                            </a>
                        </li>
                        
                        <li>
                            <a href="http://www.twitter.com/_mjpitz_">
                                <i class="fab fa-twitter" title="Twitter" data-toggle="tooltip" data-placement="bottom">
                                    <span>Twitter</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="http://www.linkedin.com/in/mjpitz">
                                <i class="fab fa-linkedin" title="LinkedIn" data-toggle="tooltip" data-placement="bottom">
                                    <span>LinkedIn</span>
                                </i>
                            </a>
                        </li>

                        <li>
                            <a href="/feed.xml">
                                <i class="fas fa-rss" title="Feed" data-toggle="tooltip" data-placement="bottom">
                                    <span>Feed</span>
                                </i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mjpitz-content" style="margin-top:82px">
            <div class="panel panel-default">
    <div class="panel-body">
        <div class="post">
            <h1 class="post-title">NodeJS gRPC Code Reference</h1>
            <p class="post-date">Posted on May 07, 2018</p>

            <div class="post-content">
                <p>While working at Indeed, I did a fair amount with <a href="https://grpc.io/">gRPC</a>.
I became rather familiar with the Java, Go, NodeJS, and python implementations.
During my vacation between jobs, I decided to revisit one of my old projects and try to migrate it to using gRPC.
By doing so, I would be able to support a larger variety of request types (streaming, non-streaming, etc).
When I started to look for good NodeJS code samples or reference implementations, I was rather disappointed with what I found.
Many of the ones I could get my hands on only demonstrated unary methods and not any of the streaming APIâ€™s.
After a lot of time digging through source and a few implementations online, I finally assembled a good reference.</p>

<p>In this post, I only wanted to detail what the method calls look like on both ends of the wire.
There are some additional best practices that should be taken into consideration, but I do not plan on covering those here.</p>

<!--more-->

<h2 id="protocol-buffers-definition">Protocol Buffers Definition</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message Request {
}

message Response {
}

service MyService {
    rpc unaryMethod(Request) returns (Response);
    rpc clientStreamingMethod(stream Request) returns (Response);
    rpc serverStreamingMethod(Request) returns (stream Response);
    rpc bidirectionalStreamingMethod(stream Request) returns (stream Response);
}
</code></pre></div></div>

<h2 id="service-implementation">Service Implementation</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">grpc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">grpc</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">MyServiceGrpc</span> <span class="o">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">./MyService.proto</span><span class="dl">'</span><span class="p">));</span>

<span class="kd">class</span> <span class="nx">MyServiceImpl</span> <span class="p">{</span>
    <span class="nx">unaryMethod</span><span class="p">(</span><span class="nx">call</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
        <span class="c1">// handle request</span>
        <span class="nx">callback</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="nx">clientStreamingMethod</span><span class="p">(</span><span class="nx">call</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// handle request</span>
        <span class="p">});</span>
        
        <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="nx">serverStreamingMethod</span><span class="p">(</span><span class="nx">call</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
        
        <span class="c1">// call N times</span>
        <span class="nx">call</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        
        <span class="c1">// call once</span>
        <span class="nx">call</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="nx">bidirectionalStreamingMethod</span><span class="p">(</span><span class="nx">call</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// handle request</span>
            <span class="nx">call</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        <span class="p">});</span>
        
        <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">call</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">();</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">addService</span><span class="p">(</span><span class="nx">MyServiceGrpc</span><span class="p">.</span><span class="nx">MyService</span><span class="p">.</span><span class="nx">service</span><span class="p">,</span> <span class="k">new</span> <span class="nx">MyServiceImpl</span><span class="p">());</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="dl">'</span><span class="s1">0.0.0.0:1234</span><span class="dl">'</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerCredentials</span><span class="p">.</span><span class="nx">createInsecure</span><span class="p">());</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="client-usage">Client Usage</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">grpc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">grpc</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">MyServiceGrpc</span> <span class="o">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">./MyService.proto</span><span class="dl">'</span><span class="p">));</span>

<span class="kd">const</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">createInsecure</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyServiceGrpc</span><span class="p">.</span><span class="nx">MyService</span><span class="p">(</span><span class="dl">'</span><span class="s1">0.0.0.0:1234</span><span class="dl">'</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">md</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">Metadata</span><span class="p">();</span>

<span class="c1">// unary</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">unaryMethod</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// handle err</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// handle response</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// client streaming</span>
<span class="p">{</span>
    <span class="kd">const</span> <span class="nx">call</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">clientStreamingMethod</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// handle err</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// handle response</span>
        <span class="p">}</span>
    <span class="p">});</span>
    
    <span class="c1">// call N times</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
    
    <span class="c1">// call once</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// server streaming</span>
<span class="p">{</span>
    <span class="kd">const</span> <span class="nx">call</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">serverStreamingMethod</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">md</span><span class="p">);</span>
    
    <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// handle response</span>
    <span class="p">});</span>
    
    <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// handle end of server</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// bidirectional streaming</span>
<span class="p">{</span>
    <span class="kd">const</span> <span class="nx">call</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">bidirectionalStreamingMethod</span><span class="p">(</span><span class="nx">md</span><span class="p">);</span>
    
    <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// handle response</span>
    <span class="p">});</span>
    
    <span class="nx">call</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// handle end of server</span>
    <span class="p">});</span>
    
    <span class="c1">// call N times</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
    
    <span class="c1">// call once</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="other-points-of-reference">Other Points of Reference</h2>

<p><strong>Code in grpc/grpc-node</strong></p>

<p>Source code is always a great point of reference.
gRPC has several good integration tests where you can see some of these approaches being used.</p>

<ul>
  <li><a href="https://github.com/grpc/grpc-node/blob/master/test/interop/interop_server.js">https://github.com/grpc/grpc-node/blob/master/test/interop/interop_server.js</a></li>
  <li><a href="https://github.com/grpc/grpc-node/blob/master/test/interop/interop_client.js">https://github.com/grpc/grpc-node/blob/master/test/interop/interop_client.js</a></li>
  <li><a href="https://github.com/grpc/grpc-node/blob/master/test/performance/benchmark_server.js">https://github.com/grpc/grpc-node/blob/master/test/performance/benchmark_server.js</a></li>
  <li><a href="https://github.com/grpc/grpc-node/blob/master/test/performance/benchmark_client.js">https://github.com/grpc/grpc-node/blob/master/test/performance/benchmark_client.js</a></li>
</ul>

            </div>

            <div class="text-center">
    <br/>
    <br/>
    <p><i>Share this article on</i></p>

    <div style="font-size: 36px;">
        <a rel="nofollow" target="_blank" href="https://facebook.com/sharer.php?u=https://www.mjpitz.com/blog/2018/05/07/nodejs-grpc-code-reference/">
            <i class="fab fa-facebook" title="Facebook" data-toggle="tooltip" data-placement="bottom"></i></a>
        &nbsp;
        <a rel="nofollow" target="_blank" href="https://twitter.com/intent/tweet?text=NodeJS gRPC Code Reference&url=https://www.mjpitz.com/blog/2018/05/07/nodejs-grpc-code-reference/&via=&related=">
            <i class="fab fa-twitter" title="Twitter" data-toggle="tooltip" data-placement="bottom"></i></a>
        &nbsp;
        <a rel="nofollow" target="_blank" href="http://www.linkedin.com/sharing/share-offsite/?url=https://www.mjpitz.com/blog/2018/05/07/nodejs-grpc-code-reference/">
            <i class="fab fa-linkedin" title="LinkedIn" data-toggle="tooltip" data-placement="bottom"></i></a>
    </div>
</div>


            <div class="post-footer row">
                <div class="col-sm-6 text-left">
                    
                        <a class="btn btn-default" href="/blog/2017/06/14/delaying-message-processing/">&laquo; Previous Post</a>
                    
                </div>

                <div class="col-sm-6 text-right">
                    
                    <a class="btn btn-default" href="/blog/2018/10/27/lambda-local-development/">Next Post &raquo;</a>
                    
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
        <div style="padding:25px 0; margin-top: 50px;">
    <div>
        
<!-- Google Analytics (http://google.com/analytics) -->
<script>
    !function(j,e,k,y,l,L){j.GoogleAnalyticsObject=y,j[y]||(j[y]=function(){
        (j[y].q=j[y].q||[]).push(arguments)}),j[y].l=+new Date,l=e.createElement(k),
            L=e.getElementsByTagName(k)[0],l.src='//www.google-analytics.com/analytics.js',
            L.parentNode.insertBefore(l,L)}(window,document,'script','ga');
    ga('create', 'UA-39314903-5', 'auto');
    ga('send', 'pageview');
</script>



        <script src="/statics/libs/jquery-2.1.4/jquery.min.js"></script>
        <script src="/statics/libs/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="/statics/libs/mermaid-8.5.0/mermaid.min.js"></script>

        <script>
            mermaid.initialize({
                startOnLoad:true,
                flowchart: {
                    useMaxWidth: true,
                }
            });

            $(function () {
                $('[data-toggle="tooltip"]').tooltip();
                $('.collapse').collapse({ toggle: false });
            });
        </script>
    </div>
</div>

    </body>
</html>
